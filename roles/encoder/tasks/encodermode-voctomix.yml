---
  # see packages.yml for gstreamer package installation

  # directories & code
  - name: create voctomix directories
    file: dest={{ item }} state=directory
          owner=root group=root
    with_items:
      - /video/
      - /video/intros/
      - /video/music/
      - /opt/voctomix/scripts/
      - /opt/voctomix/release/

  - name: checkout voctomix release
    git: repo=https://c3voc.de/git/voctomix
         dest=/opt/voctomix/release/
         version=0.2
         force=yes
         accept_hostkey=yes



  # voctocore service
  - name: create voctocore systemd-unit
    template: src=systemd-units/voctomix-voctocore.service.j2
              dest=/etc/systemd/system/voctomix-voctocore.service
              mode=0644 owner=root group=root

  - name: enable voctocore service when in voctomix-mode
    service: name=voctomix-voctocore
             enabled=yes
             state=started
    when: encodermode is defined and encodermode == 'hd-voctomix'

  - name: disabled voctocore service when not in voctomix-mode
    service: name=voctomix-voctocore
             enabled=no
             state=stopped
    when: encodermode is not defined or encodermode != 'hd-voctomix'



  # decklink sources
  - name: list decklink input devices
    shell: ffmpeg -hide_banner -f decklink -list_devices 1 -i dummy 2>&1 | grep decklink | grep "'" | cut -d"'" -f2
    register: decklink_devices
    changed_when: False

  - name: calculating sources
    set_fact:
      number_decklink: "{{ decklink_devices.stdout_lines | length }}"
      number_sources: "{{ [2, decklink_devices.stdout_lines | length] | max }}"

  - name: print source information
    debug: msg="Found {{ number_decklink }} Decklink Inputs ({{ decklink_devices.stdout_lines }}), Configuring Voctocore with {{ number_sources }} Sources (Minumum=2)"

  - name: create decklink-source scripts
    template: src=voctomix-scripts/decklink-source.sh.j2
              dest=/opt/voctomix/scripts/decklink-source-{{ item.0 + 1 }}.sh
              mode=0755 owner=root group=root
    with_indexed_items: decklink_devices.stdout_lines

  - name: create decklink-source systemd-units
    template: src=systemd-units/voctomix-decklink-source.service.j2
              dest=/etc/systemd/system/voctomix-decklink-source-{{ item.0 + 1 }}.service
              mode=0644 owner=root group=root
    with_indexed_items: decklink_devices.stdout_lines

  - name: enable decklink-source services when in voctomix-mode
    service: name=voctomix-decklink-source-{{ item.0 + 1 }}
             enabled=yes
             state=started
    when: encodermode is defined and encodermode == 'hd-voctomix'
    with_indexed_items: decklink_devices.stdout_lines

  - name: disabled decklink-source service when not in voctomix-mode
    service: name=voctomix-decklink-source-{{ item.0 + 1 }}
             enabled=no
             state=stopped
    when: encodermode is not defined or encodermode != 'hd-voctomix'
    with_indexed_items: decklink_devices.stdout_lines



    # grabber source source
  - name: create grabber-source script
    template: src=voctomix-scripts/grabber-source.sh.j2
              dest=/opt/voctomix/scripts/grabber-source.sh
              mode=0755 owner=root group=root

  - name: create grabber-source systemd-unit
    template: src=systemd-units/voctomix-grabber-source.service.j2
              dest=/etc/systemd/system/voctomix-grabber-source.service
              mode=0644 owner=root group=root

  - name: enable grabber-source services when in voctomix-mode
    service: name=voctomix-grabber-source
             enabled=yes
             state=started
    when: encodermode is defined and encodermode == 'hd-voctomix'

  - name: disabled grabber-source service when not in voctomix-mode
    service: name=voctomix-grabber-source
             enabled=no
             state=stopped
    when: encodermode is not defined or encodermode != 'hd-voctomix'



  # pause source
  - name: uploading default pause-loop
    copy: src=artwork/default-pause.ts
          dest=/video/intros/default-pause.ts
          mode=0644 owner=root group=root

  - name: creating default pause-loop symlink
    file: src=/video/intros/default-pause.ts
          dest=/video/intros/pause.ts
          state=link
          mode=0644 owner=root group=root

  - name: create pause-source scripts
    template: src=voctomix-scripts/pause-source.sh.j2
              dest=/opt/voctomix/scripts/pause-source.sh
              mode=0755 owner=root group=root

  - name: create pause-source systemd-unit
    template: src=systemd-units/voctomix-pause-source.service.j2
              dest=/etc/systemd/system/voctomix-pause-source.service
              mode=0644 owner=root group=root

  - name: enable pause-source services when in voctomix-mode
    service: name=voctomix-pause-source
             enabled=yes
             state=started
    when: encodermode is defined and encodermode == 'hd-voctomix'

  - name: disabled pause-source service when not in voctomix-mode
    service: name=voctomix-pause-source
             enabled=no
             state=stopped
    when: encodermode is not defined or encodermode != 'hd-voctomix'



    # pause music source
  - name: uploading default music-files
    copy: src=artwork/pause-music/
          dest=/video/pause-music/
          mode=0644 directory_mode=0755 owner=root group=root

  - name: create music-source script
    template: src=voctomix-scripts/music-source-from-folder.py.j2
              dest=/opt/voctomix/scripts/music-source-from-folder.py
              mode=0755 owner=root group=root

  - name: create music-source systemd-unit
    template: src=systemd-units/voctomix-music-source.service.j2
              dest=/etc/systemd/system/voctomix-music-source.service
              mode=0644 owner=root group=root

  - name: enable music-source services when in voctomix-mode
    service: name=voctomix-music-source
             enabled=yes
             state=started
    when: encodermode is defined and encodermode == 'hd-voctomix'

  - name: disabled music-source service when not in voctomix-mode
    service: name=voctomix-music-source
             enabled=no
             state=stopped
    when: encodermode is not defined or encodermode != 'hd-voctomix'



  # voctocore configuration
  - name: create voctocore config
    template: src=voctomix-config/voctocore-config.ini.j2
              dest=/opt/voctomix/voctocore-config.ini
              mode=0644 owner=root group=root
